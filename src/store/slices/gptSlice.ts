// store/slices/gptSlice.ts
import { createSlice, type PayloadAction } from "@reduxjs/toolkit";
import {
  type Edge,
  type Connection,
  type NodeChange,
  type EdgeChange,
  applyNodeChanges,
  applyEdgeChanges,
  addEdge,
  reconnectEdge,
} from "@xyflow/react";
import type { CustomNode, CustomNodeData } from "../../types";

interface InitialStateI {
  data: {
    nodes: CustomNode[];
    edges: Edge[];
  };
  isLoading: boolean;
  isError: boolean;
}

const initialState: InitialStateI = {
  data: {
    nodes: [
      {
        id: "Продукт1",
        type: "Продукт",
        data: {
          label: "автомобиль легковой",
          description:
            "Современное транспортное средство, предназначенное для перевозки людей и багажа. Характеризуется сложной конструкцией, включающей кузов, шасси, двигатель, трансмиссию, системы управления и безопасности. Применяется для личных, коммерческих и государственных нужд.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование1",
        type: "Преобразование",
        data: {
          label: "Автомобильная сборка на конвейере",
          description:
            "Промышленный конвейерный процесс сборки автомобилей, включающий поэтапную установку агрегатов и компонентов — кузова, двигателя, трансмиссии, шасси, электроники, интерьера. Осуществляется на специализированных заводах с использованием автоматизированных линий, робототехники и диагностического оборудования.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Продукт2",
        type: "Продукт",
        data: {
          label: "кузов автомобиля",
          description:
            "Основа несущей конструкции автомобиля, совмещающая элементы пассивной безопасности, эстетики и удобства. Включает наружные и внутренние панели, дверные проёмы, багажник и капот. Для производства используются сборы сварки и штамповки.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование2",
        type: "Преобразование",
        data: {
          label: "Промышленное производство автомобильных кузовов",
          description:
            "Комплексный процесс производства включает штамповку панелей из стального листа, сварку каркаса, антикоррозийную обработку и покраску. Используется оборудование для глубокой вытяжки металла, роботизированные сварочные станции и линии нанесения покрытий.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Продукт3",
        type: "Продукт",
        data: {
          label: "двигатель внутреннего сгорания",
          description:
            "Сердце автомобиля — силовая установка, преобразующая химическую энергию топлива в механическую. Состоит из блока цилиндров, поршней, коленвала, клапанного механизма, систем впрыска и охлаждения.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование3",
        type: "Преобразование",
        data: {
          label: "Сборка двигателя внутреннего сгорания",
          description:
            "Процесс сборки с высокой прецизионностью: монтаж блока, поршней, клапанов и вспомогательных систем. Используются линии с контролем качества, автоматизированные станции подачи компонентов и стенды для обкатки.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Продукт4",
        type: "Продукт",
        data: {
          label: "трансмиссия автомобиля",
          description:
            "Механизм передачи крутящего момента от двигателя к колёсной паре, включает сцепление, коробку передач, карданные и приводные валы. Ключевые детали — шестерни, синхронизаторы, подшипники.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование4",
        type: "Преобразование",
        data: {
          label: "Сборка трансмиссии",
          description:
            "Монтаж и юстировка узлов: изготовление зубчатых колёс, корпуса, валы. Сборочные линии оснащены прецизионной механической обработкой, и системами контроля соосности и зазоров.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Продукт5",
        type: "Продукт",
        data: {
          label: "шасси и подвеска автомобиля",
          description:
            "Узлы, отвечающие за ходовые качества, управляемость и надёжность. Включают раму (реже несущую), рычаги, пружины, стойки амортизаторов и стабилизаторы.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование5",
        type: "Преобразование",
        data: {
          label: "Сборка шасси и подвески",
          description:
            "Сборка рамы с приваркой кронштейнов, подбор и монтаж амортизаторов и упругих элементов. Линии оснащены гидропрессами, стендами центровки, автоматизированными сварочными роботами.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Продукт6",
        type: "Продукт",
        data: {
          label: "электрооборудование автомобиля",
          description:
            "Система обеспечения управления, освещения, комфорта и безопасности. Содержит блоки управления, кабели, предохранители, освещение, электродвигатели и прочие компоненты.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование6",
        type: "Преобразование",
        data: {
          label: "Комплектация электросистем автомобиля",
          description:
            "Изготовление и монтаж кабельных жгутов, установка блоков электронных систем, освещения и датчиков. Используются автоматизированные рабочие места для тестирования соединений, сборочные стенды.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Продукт7",
        type: "Продукт",
        data: {
          label: "интерьер и оснащение салона",
          description:
            "Комплекс деталей для внутренней отделки и комфорта: сиденья, панели, обивка, шумоизоляция, стекла, элементы управления климатом, мультимедия.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование7",
        type: "Преобразование",
        data: {
          label: "Сборка и монтаж автомобильного интерьера",
          description:
            "Изготовление и установка панелей, сидений, обивки из текстиля и пластмасс, стекол, шумоизоляции. Рабочие участки оборудованы покроечными, пресс-формами, автоматизированными линиями и установками для нанесения мягких покрытий.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Продукт8",
        type: "Продукт",
        data: {
          label: "колёса и шины",
          description:
            "Комплекс для передачи крутящего момента, амортизации и обеспечения сцепления с дорогой. Содержит металлические диски и эластомерные шины.",
        },
        position: { x: 0, y: 0 },
      },
      {
        id: "Преобразование8",
        type: "Преобразование",
        data: {
          label: "Сборка колесного комплекта",
          description:
            "Процесс объединяет производство шин (вулканизация резиновых смесей, армирование кордами) с литьём и обработкой металлических дисков. Сборочные линии оснащены вулканизационными прессами, станками и роботами.",
        },
        position: { x: 0, y: 0 },
      },
    ],
    edges: [
      // Ребра для Преобразование1
      {
        id: "e-Продукт2-Преобразование1",
        source: "Продукт2",
        target: "Преобразование1",
      },
      {
        id: "e-Продукт3-Преобразование1",
        source: "Продукт3",
        target: "Преобразование1",
      },
      {
        id: "e-Продукт4-Преобразование1",
        source: "Продукт4",
        target: "Преобразование1",
      },
      {
        id: "e-Продукт5-Преобразование1",
        source: "Продукт5",
        target: "Преобразование1",
      },
      {
        id: "e-Продукт6-Преобразование1",
        source: "Продукт6",
        target: "Преобразование1",
      },
      {
        id: "e-Продукт7-Преобразование1",
        source: "Продукт7",
        target: "Преобразование1",
      },
      {
        id: "e-Продукт8-Преобразование1",
        source: "Продукт8",
        target: "Преобразование1",
      },
      {
        id: "e-Преобразование1-Продукт1",
        source: "Преобразование1",
        target: "Продукт1",
      },

      // Ребра для Преобразование2
      {
        id: "e-Продукт9-Преобразование2",
        source: "Продукт9",
        target: "Преобразование2",
      },
      {
        id: "e-Продукт10-Преобразование2",
        source: "Продукт10",
        target: "Преобразование2",
      },
      {
        id: "e-Продукт11-Преобразование2",
        source: "Продукт11",
        target: "Преобразование2",
      },
      {
        id: "e-Продукт12-Преобразование2",
        source: "Продукт12",
        target: "Преобразование2",
      },
      {
        id: "e-Продукт13-Преобразование2",
        source: "Продукт13",
        target: "Преобразование2",
      },
      {
        id: "e-Преобразование2-Продукт2",
        source: "Преобразование2",
        target: "Продукт2",
      },

      // Ребра для Преобразование3
      {
        id: "e-Продукт14-Преобразование3",
        source: "Продукт14",
        target: "Преобразование3",
      },
      {
        id: "e-Продукт15-Преобразование3",
        source: "Продукт15",
        target: "Преобразование3",
      },
      {
        id: "e-Продукт16-Преобразование3",
        source: "Продукт16",
        target: "Преобразование3",
      },
      {
        id: "e-Продукт17-Преобразование3",
        source: "Продукт17",
        target: "Преобразование3",
      },
      {
        id: "e-Продукт18-Преобразование3",
        source: "Продукт18",
        target: "Преобразование3",
      },
      {
        id: "e-Продукт19-Преобразование3",
        source: "Продукт19",
        target: "Преобразование3",
      },
      {
        id: "e-Продукт20-Преобразование3",
        source: "Продукт20",
        target: "Преобразование3",
      },
      {
        id: "e-Продукт21-Преобразование3",
        source: "Продукт21",
        target: "Преобразование3",
      },
      {
        id: "e-Преобразование3-Продукт3",
        source: "Преобразование3",
        target: "Продукт3",
      },

      // Ребра для Преобразование4
      {
        id: "e-Продукт22-Преобразование4",
        source: "Продукт22",
        target: "Преобразование4",
      },
      {
        id: "e-Продукт23-Преобразование4",
        source: "Продукт23",
        target: "Преобразование4",
      },
      {
        id: "e-Продукт24-Преобразование4",
        source: "Продукт24",
        target: "Преобразование4",
      },
      {
        id: "e-Продукт25-Преобразование4",
        source: "Продукт25",
        target: "Преобразование4",
      },
      {
        id: "e-Преобразование4-Продукт4",
        source: "Преобразование4",
        target: "Продукт4",
      },

      // Ребра для Преобразование5
      {
        id: "e-Продукт26-Преобразование5",
        source: "Продукт26",
        target: "Преобразование5",
      },
      {
        id: "e-Продукт27-Преобразование5",
        source: "Продукт27",
        target: "Преобразование5",
      },
      {
        id: "e-Продукт28-Преобразование5",
        source: "Продукт28",
        target: "Преобразование5",
      },
      {
        id: "e-Преобразование5-Продукт5",
        source: "Преобразование5",
        target: "Продукт5",
      },

      // Ребра для Преобразование6
      {
        id: "e-Продукт29-Преобразование6",
        source: "Продукт29",
        target: "Преобразование6",
      },
      {
        id: "e-Продукт30-Преобразование6",
        source: "Продукт30",
        target: "Преобразование6",
      },
      {
        id: "e-Продукт31-Преобразование6",
        source: "Продукт31",
        target: "Преобразование6",
      },
      {
        id: "e-Продукт32-Преобразование6",
        source: "Продукт32",
        target: "Преобразование6",
      },
      {
        id: "e-Продукт33-Преобразование6",
        source: "Продукт33",
        target: "Преобразование6",
      },
      {
        id: "e-Преобразование6-Продукт6",
        source: "Преобразование6",
        target: "Продукт6",
      },

      // Ребра для Преобразование7
      {
        id: "e-Продукт34-Преобразование7",
        source: "Продукт34",
        target: "Преобразование7",
      },
      {
        id: "e-Продукт35-Преобразование7",
        source: "Продукт35",
        target: "Преобразование7",
      },
      {
        id: "e-Продукт36-Преобразование7",
        source: "Продукт36",
        target: "Преобразование7",
      },
      {
        id: "e-Продукт37-Преобразование7",
        source: "Продукт37",
        target: "Преобразование7",
      },
      {
        id: "e-Продукт38-Преобразование7",
        source: "Продукт38",
        target: "Преобразование7",
      },
      {
        id: "e-Преобразование7-Продукт7",
        source: "Преобразование7",
        target: "Продукт7",
      },

      // Ребра для Преобразование8
      {
        id: "e-Продукт39-Преобразование8",
        source: "Продукт39",
        target: "Преобразование8",
      },
      {
        id: "e-Продукт40-Преобразование8",
        source: "Продукт40",
        target: "Преобразование8",
      },
      {
        id: "e-Преобразование8-Продукт8",
        source: "Преобразование8",
        target: "Продукт8",
      },
    ],
  },
  isLoading: false,
  isError: false,
};

const gptSlice = createSlice({
  name: "gpt",
  initialState,
  reducers: {
    // Обновление метки узла
    updateNodeData: (
      state,
      action: PayloadAction<{ nodeId: string; data: Partial<CustomNodeData> }>
    ) => {
      const { nodeId, data } = action.payload;
      const node = state.data.nodes.find((node) => node.id === nodeId);
      if (node) {
        node.data = { ...node.data, ...data };
      }
    },
    removeNode: (state, action: PayloadAction<string>) => {
      const nodeId = action.payload;

      // Удаляем узел
      state.data.nodes = state.data.nodes.filter((node) => node.id !== nodeId);

      // Удаляем все ребра, связанные с этим узлом
      state.data.edges = state.data.edges.filter(
        (edge) => edge.source !== nodeId && edge.target !== nodeId
      );
    },
    // Установка узлов (для инициализации layout)
    setNodes: (state, action: PayloadAction<CustomNode[]>) => {
      state.data.nodes = action.payload;
    },
    // Установка ребер
    setEdges: (state, action: PayloadAction<Edge[]>) => {
      state.data.edges = action.payload;
    },
    // Обработка изменений узлов из React Flow
    onNodesChange: (state, action: PayloadAction<NodeChange[]>) => {
      state.data.nodes = applyNodeChanges(
        action.payload,
        state.data.nodes
      ) as CustomNode[];
    },
    // Обработка изменений ребер из React Flow
    onEdgesChange: (state, action: PayloadAction<EdgeChange[]>) => {
      state.data.edges = applyEdgeChanges(action.payload, state.data.edges);
    },
    // Добавление нового соединения
    onConnect: (state, action: PayloadAction<Connection>) => {
      state.data.edges = addEdge(action.payload, state.data.edges);
    },
    // Переподключение ребра
    onReconnect: (
      state,
      action: PayloadAction<{ oldEdge: Edge; newConnection: Connection }>
    ) => {
      const { oldEdge, newConnection } = action.payload;
      state.data.edges = reconnectEdge(
        oldEdge,
        newConnection,
        state.data.edges
      );
    },
    // Удаление ребра
    removeEdge: (state, action: PayloadAction<string>) => {
      state.data.edges = state.data.edges.filter(
        (edge) => edge.id !== action.payload
      );
    },
  },
});

export const {
  updateNodeData,
  setNodes,
  setEdges,
  onNodesChange,
  onEdgesChange,
  onConnect,
  onReconnect,
  removeEdge,
  removeNode,
} = gptSlice.actions;
export default gptSlice.reducer;
